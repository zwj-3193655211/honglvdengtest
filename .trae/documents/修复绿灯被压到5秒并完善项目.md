## 问题定位（绿灯迅速变成5秒）
- 现象来源：调度器在检测“低车流”时，会把当前绿灯的 remaining_time 直接压到 `min_green_floor`（默认 5 秒）。
- 触发条件：只要当前相位有绿灯且 `vehicle_flows` 在窗口内的统计小于阈值（默认 5），就会触发压缩。
- 关键代码：
  - 低车流判断： [server.ts](file:///c:/Users/31936/Desktop/honglvdengtest/api/server.ts#L118-L127)
  - 压缩绿灯剩余时间到 5 秒： [server.ts](file:///c:/Users/31936/Desktop/honglvdengtest/api/server.ts#L146-L148)
- 根因：开发环境/部分页面没有持续写入 `vehicle_flows` 时，统计值经常为 0（低于阈值），导致每个绿灯一开始 30 秒也会被立刻压成 5 秒。

## 备份（开始任何修改前）
- 在项目根目录旁创建时间戳备份（复制整个目录或打包 zip）。
- 备份内容包含前后端代码与本地配置（但会过滤 node_modules / dist 等可再生内容）。

## 修复：低车流压缩逻辑
- 目标：没有足够车流数据时，不要把绿灯强行压到 5 秒。
- 实施方案（择其一，优先从最稳妥开始）：
  1) “无数据不压缩”：低车流判断改为 `SUM < threshold` 且窗口内至少有 N 条记录（或至少覆盖 2 个方向的数据）。
  2) “用最新快照替代窗口求和”：像 AI 输入一样取各方向最新一条 `vehicle_flows` 作为当前队列/车流快照，再判断是否低于阈值。
  3) “启动保护期”：绿灯刚切换到 GREEN 的前 X 秒不做低车流压缩（避免初始化立刻被压）。
- 同时把 `intersection_params.min_green_floor` 的默认值从 5 调整为更合理的下限（例如 10 或 15），并让它可在设置页配置。

## 完善：时段/文案（“模拟时段：后端实时 剩余 4s”）
- 目标：UI 文案与数据语义一致；展示“高峰/平峰/低谷”等真实含义。
- 方案：
  - 把 IntersectionMonitor 的文案从“模拟时段”改为“交通时段/交通等级”（避免后端实时也叫模拟）。
  - 新增“时段判定”逻辑：
    - A) 基于时间表（例如 7–9、11–13、17–19 高峰），存入数据库并可配置；或
    - B) 基于近 N 分钟车流量统计自动分级（推荐，和实际数据联动）。
  - 前端三页统一展示同一套时段标签与剩余时间（剩余=本时段剩余或统计窗口剩余，二者择一且统一）。

## 完善：数据一致性 / 数据保存
- 目标：仪表盘、交通控制、功能演示对“同一路口”的数据读取一致且可复现。
- 方案：
  - 明确单一数据源：以数据库/后端为准；模拟数据只作为“可选的注入器”，默认不覆盖真实数据。
  - 将 selected intersection 持久化为后端状态（已有 `/api/settings/selected-intersection`），并让三页都以它为优先默认值。
  - 对关键表（traffic_lights / vehicle_flows / intersections / intersection_params）补齐必要的约束与索引，保证读写一致。

## 完善：交通控制页面
- 目标：从“能看能点”提升为“可控、可追踪、可回放”。
- 增强项：
  - 增加当前路口的车流/队列快照显示与刷新策略。
  - 增加相位级别的控制（切相位/延长绿灯/恢复自动），而不仅仅是单灯 setState。
  - 增加“应用 AI 建议”的可视化与撤销/审计（记录到 DB）。

## 完善：车流量计算与绘图
- 目标：趋势图真实反映指定路口的车流变化。
- 方案：
  - 后端提供聚合接口（按 10s/1min 桶聚合 vehicle_flows），前端只拉聚合结果。
  - 保留 socket 实时推送用于“最新点”，历史用 HTTP 拉取。

## 完善：设置功能
- 目标：把现在散落在 env/默认值/表字段里的参数，集中到设置页可配置并持久化。
- 方案：
  - 系统级：cycleMax、黄灯范围、AI 间隔等。
  - 路口级：low_flow_window_seconds、low_flow_threshold、min_green_floor、最大绿灯等。

## 完善：空壳补全（可选但建议）
- 认证模块目前是壳： [auth.ts](file:///c:/Users/31936/Desktop/honglvdengtest/api/routes/auth.ts#L1-L33)
- 若您希望上线/多用户使用：实现真正的登录/鉴权；否则可明确标注为 demo 并移除入口避免误导。

## 验证方式
- 单元/脚本：构造无 vehicle_flows 的场景，确保绿灯不会被压到 5 秒。
- 端到端：启动 dev，切换同一路口，三页展示的灯态/队列/趋势一致。
- 回归：确认 AI 模式开启时仍可正常调整时长且不会出现“初始化立刻 5 秒”。

如果您确认这个方案，我将先做备份，然后按上述顺序开始修复 5 秒问题并逐项补齐功能。