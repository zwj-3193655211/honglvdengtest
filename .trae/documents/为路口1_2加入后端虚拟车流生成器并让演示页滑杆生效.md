## 现状确认（虚拟数据来源）
- 后端不会自己随机生成 `vehicle_flows`；它只会在收到写入请求时落库并通过 Redis→Socket 广播。
- 前端的 `useIntersectionSim` 才会用随机/泊松到达生成队列，并可选同步到后端（当前已做成开关）。

## 目标
- 路口 1/2 在“非维护状态（status=1）”时，后端持续产出稳定的虚拟车流（无需打开任何页面）。
- 功能演示页只保留“选择路口”，不再选择数据源；同时保留到达/释放缩放滑杆，并且滑杆能影响系统里的车流数据。

## 方案选择（推荐后端虚拟传感器）
- 选择：实现后端内置“虚拟传感器生成器”，周期性写入 `vehicle_flows` 并发布 `sensor:batch_data`。
- 原因：不依赖前端页面是否打开；所有页面看到的都是同一套虚拟数据，满足“永远都有车流”。

## 后端实现
1) **新增虚拟车流服务**（新文件）
- `api/services/virtualFlowGenerator.ts`
- 逻辑：
  - 仅对 intersectionId ∈ {1,2} 生效。
  - 若路口 `status!=1`（维护）则暂停生成并不写入。
  - 维护一个内存队列 `queueLen[intersectionId][direction]`（四方向）。
  - 每 N 秒（默认 1~5 秒可配）
    - 计算到达量：`arrivals = baseRate(period, direction) * arrivalScale`（稳定/可预测，可加入轻微平滑，不用随机也能“稳定”）。
    - 计算释放量：读取 DB 当前灯态，若该方向当前为绿灯则 `release = min(queue, baseCap * releaseScale)`，否则 0。
    - 更新队列：`queue = max(0, queue + arrivals - release)`。
    - 写入 `vehicle_flows(vehicle_count=queue)`（作为队列快照），并 publish `sensor:batch_data`（前端已监听 `vehicleFlowUpdate`）。
  - 加一个清理策略（可选）：定时删除过旧的 `vehicle_flows`（例如保留 24h），避免表无限增长。

2) **扩展路口参数表用于滑杆**
- 扩展 `intersection_params` 增加字段（DECIMAL）：
  - `arrival_straight_scale`
  - `arrival_left_scale`
  - `release_straight_scale`
  - `release_left_scale`
- 在 `ensureSchema()` 中做增量迁移（缺字段则 ALTER ADD），并提供合理默认值。

3) **扩展 settings 接口读写这些字段**
- 复用现有：`GET/PUT /api/settings/intersection-params/:intersectionId`
- 让返回/更新包含四个 scale 字段。

4) **在 server.ts 启动虚拟车流循环**
- 在 `startLoopsOnce()` 中加入 `startVirtualFlowGenerator()`，与红绿灯调度/AI 一起启动。

## 前端实现（功能演示页）
1) **移除数据源选择**
- `src/pages/Demo.tsx`：去掉“后端实时/模拟演示”的切换，只保留“选择路口”。

2) **保留滑杆并让其真正生效**
- Demo 页面保留 4 个滑杆。
- 页面加载时：调用 `GET /api/settings/intersection-params/:id` 读取当前 scale 默认值。
- 滑杆变化时：节流/防抖调用 `PUT /api/settings/intersection-params/:id` 写入 scale（持久化），后端生成器下一次 tick 立刻按新 scale 生成数据。

## 维护路口不可选择（与本需求一致的补强点）
- 确保路口维护时：
  - 后端生成器停止对该路口写 `vehicle_flows`。
  - 前端下拉列表不会出现维护路口（或被禁用）。

## 验证
- 后端：启动后不打开任何页面，持续请求 `GET /api/vehicle-flows/aggregate?intersection_id=1...` 应有数据。
- 前端：打开 Demo 页拖动滑杆，观察趋势/队列数变化（到达上升→队列上升更快；释放上升→绿灯期间队列下降更快）。
- 维护切换：把路口 status 设为 0 后，该路口应从下拉消失且车流生成停止。

我会在你确认后开始按以上步骤落地（涉及新增后端服务、扩表迁移、Demo 页改回“仅选路口+滑杆生效”）。